<!DOCTYPE html> <html>
<head> 

<style>
pre {
    background-color: #F5F5F5;
	border: 5px solid #8e9baf;
    display: inline-block;
	height: 500px;
    width: 100%;
    overflow: auto;
    background-color: #eeeeee;
	text-align: left;
	padding-left: 3px;
	font-size: 125%;
}
</style>


<script>
//http://www.somethinghitme.com/2013/01/09/creating-a-canvas-platformer-tutorial-part-one/
var up = 1;
var down = 2;
var left = 3;
var right = 4;

var xDir;
var yDir;

var dx = 5;
var dy = 20;

var startM = 0;
var endM = 12;
var countSpeed = 0;
var mapWorlds = {};

var world1 = [
	//40 width
	//10 height
	[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
	[0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
	[1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
	[1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0]
	
];

var bound = [
	[],
	[],
	[],
	[],
	[],
	[],
	[],
	[],
	[],
	[]
];

var mainImg = new Image();
mainImg.src = "http://www.clker.com/cliparts/X/9/P/m/2/g/transparent-red-circle-md.png";
var mainImgRad = 25;


var player = {
	//not centered
	width: 50,
	height: 50,
	x: 50,
	y: 350,
	speed: 3,
	velX: 0,
	velY: 0,
	jumping: false,
	grounded: false,
	move: true
};

var gravity = 0.3;
var friction = 0.8;

var pause = false;

var box = 1;
var spike = 2;
var air = 3;
/*
var jumpD = [];
var jumpDX = [];
var jumpCounter =0;
var canJump = true;
*/

var keys = [];
function start() {
	window.addEventListener("keydown", keyDown);
	window.addEventListener("keyup", keyUp);
	document.getElementById("myCanvas").addEventListener("mousemove", mouseMove);
	document.getElementById("myCanvas").addEventListener("mousedown", mouseDown);
	
	
	
	for (var i = 0; i < world1.length; i++) {
		for (var j = 0; j < world1[i].length; j++) {
			if (world1[i][j] == 1) {

				bound[i].push({
					x: j*50,
					y: i*50,
					width: 50,
					height: 50,
					type: box
				});
			} else if (world1[i][j] == 4) {
				bound[i].push({
					x: j*50,
					y: i*50,
					width: 50,
					height: 50,
					type: spike
				});
			} else {
				bound[i].push({
					type: air
				});
			}
		}
	}
	/*
	//400(t-t^2)
	//dDist from 0.0-0.1 [400(0.1-0.01)]
	//dDist from 0.1-0.2 [400(0.2-0.04) - 400(0.1-0.01)] = 400(0.2 - 0.04 - 0.1 + 0.01)
	//0.2-0.3
	//0.3-0.4
	//0.4-0.5
	for (var i = 0; i < 6; i++) {
		// dist = 400 T - 400  T *T = 400 (T - T * T)
		var dist = 400 * ((i/10) - (i*i/100));
		jumpD[i] = dist;
	}
	
	for (var i = 0; i < 5; i++) {
		jumpDX[i] = jumpD[i+1] - jumpD[i];
	}
	jumpDX[5] = 0;*/
	
	onTick();
	perSec();

}

function mouseDown(e) {

}

function mouseMove(e) {

}

function keyUp(e) {
	keys[e.keyCode] = false;
}

function keyDown(e) {
	keys[e.keyCode] = true;
	
	if (keys[80]) {
		pause = !pause;
		//console.log("pause: " + pause);
	}
}
	
	
function onTick() {
	window.setTimeout(onTick, 20);
	
	drawScreen();
}
	
	
	
function perSec() {

	window.setTimeout(perSec, 1000);
	
	//startM++;
	//endM++;
}

function colCheck(shapeA, shapeB) {
    // get the vectors to check against
    var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2));
    var vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2));
        // add the half widths and half heights of the objects
    var hWidths = (shapeA.width / 2) + (shapeB.width / 2);
    var hHeights = (shapeA.height / 2) + (shapeB.height / 2);
    var colDir = null;
 
    // if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision
    if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {         // figures out on which side we are colliding (top, bottom, left, or right)        
		var oX = hWidths - Math.abs(vX);         
		var oY = hHeights - Math.abs(vY);         
		if (oX >= oY) {
			if (vY > 0) {
				colDir = "t";
				shapeA.y += oY;
			} else {
				colDir = "b";
				shapeA.y -= oY;
			}
		} else {
			if (vX > 0) {
				colDir = "l";
				shapeA.x += oX;
			} else {
				colDir = "r";
				shapeA.x -= oX;
			}
		}
	}
    return colDir;
}

function checkSpike(triangle) {
	//TODO
	/*
			A
			*
		   / \
		  /	  \
		B *----* C
		y = mx + b
	*/
	//Slope of AB (m)
	var a = {
		x: triangle.x + triangle.width/2,
		y: triangle.y
	};
	
	var b = {
		x: triangle.x,
		y: triangle.y + triangle.height
	};
	
	var c = {
		x: triangle.x + triangle.width,
		y: triangle.y + triangle.height
	};
	
	//console.log(a.x + " " + a.y);  
	//console.log(b.x + " " + b.y);
	//console.log(c.x + " " + c.y);
	
	var aSlope = Math.floor((a.y - b.y) / (a.x - b.x));
	//(b)
	var aOff = a.y - (a.x * aSlope); 
	//TODO fix offsets
	//slope of BC = 0
	var bOff = b.y;
	//slope of AC
	var cSlope = Math.floor((a.y - c.y) / (a.x - c.x));
	//(b)
	var cOff = c.y - (c.x * cSlope);
	
	console.log(a.x + " *" + aSlope + " = " + aSlope*a.x + " vs " + a.y);
	//console.log(aOff + " " + bOff + " " + cOff);
	
	/*
		if (equation of the circle is less than all of the equations of the lines of the triangle) {
			then circle is inside triangle
		}
	*/
	
	//circle equation: (x-h)^2 + (y+k)^2 = r^2
	//circle at (h, k)
	//var h = player.x;
	//var k = player.y;
	
	var lX = player.x - player.width/2;
	var lY = player.y;
	
	var rX = player.x + player.width/2;
	var rY = player.y;
	
	var uX = player.x;
	var uY = player.y - player.height/2;
	
	
	console.log(aSlope + " * " + lX + " + " + aOff + " = " + (aSlope*lX+aOff) + " vs " + player.x);
	
	if ((aSlope*lX + aOff >= lY) && (cSlope*lX + cOff >= lY) && (bOff >= lY)) {
		console.log("touch");
		pause = true;
	}
	
	if ((aSlope*rX + aOff >= rY) && (cSlope*rX + cOff >= rY) && (bOff >= rY)) {
		console.log("touch");
		pause = true;
	}
	if ((aSlope*uX + aOff >= uY) && (cSlope*uX + cOff >= uY) && (bOff >= uY)) {
		console.log("touch");
		pause = true;
	}
	
}

	function drawScreen() {
		var canvas = document.getElementById("myCanvas");
		var context = canvas.getContext("2d");
		var height = canvas.height;
		var width = canvas.width;
		var div = document.getElementById("myDiv");
		var width = canvas.width;
		var height = canvas.height;
		
		
		if (!pause) {
			 if (keys[32] || keys[87]) {
				// up arrow or space
			  if(!player.jumping){
			   player.jumping = true;
			   player.velY = -player.speed*2;
			  }
			}
			if (keys[68]) {
				// right arrow
				if (player.velX < player.speed) {             
					player.velX++;         
				 }     
			}     
			if (keys[65]) {         
				// left arrow         
				if (player.velX > -player.speed) {
					player.velX--;
				}
			}
			
		 
			player.velX *= friction;
		 
			player.velY += gravity;
		 
			player.x += player.velX;
			player.y += player.velY;
			
			//console.log(player.velX + " " + player.velY);
			if (Math.floor(player.velX) == 0) {
				player.move = false;
				
			} else{
				player.move = true;
			}
			
			if (player.x >= width-player.width) {
				player.x = width-player.width;
			} else if (player.x <= 0) {  
				//GAMEOVER
				player.x = 0;   
				//console.log("LOSE");
				pause = true;
			}    
		  
			//falls down into hole
			if(player.y >= height){
			
				//GAMEOVER
				pause = true;
				/*
				player.y = height - player.height;
				//console.log("TOUCHED");
				player.jumping = false;
				*/
			} 
		
			player.grounded = false;
			
			
			
			for (var i = 0; i < bound.length; i++) {
				for (var j = 0; j < 12; j++) {
					if(bound[i][j].type == box) {
						var dir = colCheck(player, bound[i][j]);
				 
						if (dir === "l" || dir === "r") {
							player.velX = 0;
							player.jumping = false;
						} else if (dir === "b") {
							player.grounded = true;
							player.jumping = false;
						} else if (dir === "t") {
							player.velY *= -1;
						}
					} else if (bound[i][j].type == spike) {
						checkSpike(bound[i][j]);
					}
				}
			}
		 
			if(player.grounded){
				 player.velY = 0;
			}
		}
	
		
		
		context.clearRect(0, 0, 500, 500);
		
		context.fillStyle = "#ffffff";
		context.fillRect(0, 0, canvas.width, canvas.height);
		//alert("2");
		
		context.strokeStyle = "#000000";
		context.strokeRect(1, 1, canvas.width - 2, canvas.height - 2);
		
		if (!pause) {
			if (countSpeed > 75) {
				endM++;
			}
		}
		
		for (var i = 0; i < world1.length; i++) {
			for (var j = 0; j < endM; j++) {
				
				var img = new Image();
				var pix = world1[i][j];
				if (pix == 1) {
					img.src = "https://i.stack.imgur.com/ZcPaO.png";
					context.drawImage(img, j*50 - countSpeed, i*50, 50, 50);
					bound[i][j].x = j*50-countSpeed;
				} else if (pix == 4) {
					img.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/Green_equilateral_triangle_point_up.svg/886px-Green_equilateral_triangle_point_up.svg.png";
					context.drawImage(img, j*50-countSpeed, i*50, 50, 50);
					bound[i][j].x = j*50 - countSpeed;
				}
			}
		}
		if (!pause) {
			if (player.move == false) {
				player.x -= 1.5;
			}
			//console.log(player.move);
			for (var i = 0; i < bound.length; i++) {
				bound[i].x -= countSpeed;
			}
			countSpeed += 1.5;
		
		}
		
		//character
		context.drawImage(mainImg, player.x, player.y, player.width, player.height);
		//console.log(mainImg.height);
	}
	
	
	
	
	
	
	

function println(words, color) {
	var console = document.getElementById("console");
	var linebr = document.createElement("br");
	var span = document.createElement('span');
	span.style.color = color;
	console.append(span);
	span.append(words);
	span.append(linebr);
	console.scrollTop += 50;
}

function printlnTimer(message, color, index, interval, callback) {
  var console = document.getElementById("console");
  if (index < message.length) { 
	var span = document.createElement('span');
	span.style.color = color;
	console.append(span);
	span.append(message[index++]); 
	timer += interval;
	setTimeout(function () { printlnTimer(message, color, index, interval, callback); }, interval); 
  } else {
	var linebr = document.createElement("br");
	console.append(linebr);
	callback && callback();
  }
  console.scrollTop += 50;
};

function print(words, color) {
	var console = document.getElementById("console");
	var span = document.createElement('span');
	span.style.color = color;
	console.append(span);
	span.append(words);
	console.scrollTop += 50;
}

function printTimer(message, color, index, interval, callback) {
  var console = document.getElementById("console");
  
  if (index < message.length) { 
	var span = document.createElement('span');
	span.style.color = color;
	console.append(span);
	span.append(message[index++]); 
	timer += interval;
	setTimeout(function () { printTimer(message, color, index, interval, callback); }, interval); 
  } else {
	callback && callback();
  }
  console.scrollTop += 50;
};


</script>
</head>
<body onload="start()" >


<table>
<tr height="100%">
<td width="50%">
<div id="myDiv">
<canvas id="myCanvas" width="500" height="500">
Your browser does not support the HTML5 canvas tag.
</canvas></div></td>


<td width="50%">
<div id="div2" style="text-align:center" >
<pre id="console"></pre></div>
</td>
</tr>
</table>
</body>
</html>