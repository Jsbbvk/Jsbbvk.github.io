<!DOCTYPE html><html>
<head>
    <style>
    #myCanvas {
       
        border: 10px solid black;
    }
    .rectangle {
        border: 1px solid #FF0000;
        position: absolute;
    }
    </style>
    <script src="ocrad.js"></script>
    <script src='https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js'></script>
    <script>
        
        
        var imageDatas = [];
        var canvas;
        var context;
        
        function checkIfBlack(pixel, threshold) {
            console.log("A");
            threshold = threshold || 200;

            for(var i=0; i<3; i++) {
                if(pixel[i] > threshold) {
                    return false;
                }
            }

            return true;
        }
        
        function clearLines() {
            var img = context.getImageData(0, 0, canvas.width, canvas.height);
            console.log(img);
            
            
            /*
            for(var i=0; i<img.width; i++){
                var isBlack = true;
                for(var j=0; j<img.height; j++){
                   //console.log(i*img.width+j);
                    console.log(img[i*img.width]);
                    if (pixel >= 200) {
                        img[i*img.width+j] = 255;
                    }
                   
                    
                }
//                if (isBlack == true) {  
//                    for(var j=0; j<img.height; j++){
//                        for(var k=0; k<4; k++){
//                            img[i * img.width + j + k] = 255;
//                        }
//                    }
//                }
                
            }

            for(var i=0; i<img.height; i++){
                var isBlack;
                for(var j=0; j<img.width; j++){
                    var pixel = img[i + j * img.width];
                    if (pixel >= 200) {
                        img[i+j*img.width] = 255;
                    }
                    
                }
//                if (isBlack == true) {
//                        for(var j=0; j<img.height; j++){
//                            for(var k=0; k<4; k++){
//                                img[i + j * img.width + k] = 255;
//                            }
//                        }
//                    }
//                
            }
            
            */
            
            var w = img.height;
            var notBlack = true;
            
            var numBlack = 0;
            var nonBlack = 0;
            for (var i = 0; i < img.height*100; i++) {
                //console.log(img.data[i]);  
                //img.data[i] = 100;
            }
            for (var i = 0; i < img.data.length; i+=4) {
                w--;
                var red = img.data[i]; //red
                var green = img.data[i+1]; // green
                var blue = img.data[i+2]; // blue
                if (red <= 200 && blue <= 200 && green <= 200) {
                    //img.data[i] = 255;
                    //img.data[i+1] = 255;
                    //img.data[i+2] = 255;
                    numBlack++;
                } else {
                    nonBlack++;
                }
                
                if (w <= 0) {
                    w = img.width;
                    console.log(notBlack);
                    if (numBlack >= nonBlack) {
                        for (var j = i-img.width*4; j <= i; j+=4) {
                            img.data[j] = 255;
                            img.data[j+1] = 255;
                            img.data[j+2] = 255;
                        }
                        nonBlack = 0;
                        numBlack = 0;
                    }
                    
                }
            }
            /*
            for (var y = 0; y < canvas.height; y++) {
                for (var x = 0; x < canvas.width; x+=3) {
                    var idx = y*canvas.width + x;   
                    var red = img[idx]; //red
                    var green = img[idx+1]; // green
                    var blue = img[idx+2]; // blue
                    
                    //if (red <= 100 || green <= 100 || blue <= 100) {
                    //img.data[i+3] = 0;
                            img[idx] = 255;
                            img[idx+1] = 255;
                            img[idx+2] = 255;
                        
                    
                }
            }
            /*
            for (var i = 0; i < img.data.length; i += 4) {
                var red = img.data[i]; //red
                var green = img.data[i+1]; // green
                var blue = img.data[i+2]; // blue

                if (red <= 100 && green <= 100 && blue <= 100) {
                    //img.data[i+3] = 0;
                    img.data[i] = 255;
                    img.data[i+1] = 255;
                    img.data[i+2] = 255;
                }
            }*/
            var img1 = new Image(img);
            context.putImageData(img, 0, 0);
        }
        
        
        function init() {
            canvas = document.getElementById('myCanvas');
            context = canvas.getContext('2d');
            canvasHolder = document.getElementById("canvasHolder");
            
            
            var img = document.getElementById('picture');
            //scans pic first
            Tesseract.recognize(img)
                .progress(function  (p) { 
                    //console.log('progress', p)    
                })
                .then(function (result) { 
                 
                    result.words.forEach(function (w) {
                        console.log(w.text);
                    });
                    
                    //console.log(result);
                })
            
            function drawScreen() {
                
                canvas.width = img.width;
                canvas.height = img.height;
                context.drawImage(img, 0, 0 );
                
                console.log(imageDatas.length);
                if (imageDatas.length > 0) {
                    //var str = OCRAD(imageDatas[0]);
                    //console.log(str);
                    requestAnimationFrame(drawScreen);
                }
            }
            drawScreen();
            
            var mouse = {
                x: 0,
                y: 0,
                startX: 0,
                startY: 0
            };

            function setMousePosition(e) {
                var ev = e || window.event; //Moz || IE
                if (ev.pageX) { //Moz
                    mouse.x = ev.pageX + window.pageXOffset;
                    mouse.y = ev.pageY + window.pageYOffset;
                } else if (ev.clientX) { //IE
                    mouse.x = ev.clientX + document.body.scrollLeft;
                    mouse.y = ev.clientY + document.body.scrollTop;
                }
            };



                var element = null;

            canvasHolder.onmousemove = function (e) {
                setMousePosition(e);
                if (element !== null) {
                    element.style.width = Math.abs(mouse.x - mouse.startX) + 'px';
                    element.style.height = Math.abs(mouse.y - mouse.startY) + 'px';
                    element.style.left = (mouse.x - mouse.startX < 0) ? mouse.x + 'px' : mouse.startX + 'px';
                    element.style.top = (mouse.y - mouse.startY < 0) ? mouse.y + 'px' : mouse.startY + 'px';
                }
            }
            var crop = function(canvas, offsetX, offsetY, width, height, callback) {
                // create an in-memory canvas
                var buffer = document.createElement('canvas');
                var b_ctx = buffer.getContext('2d');
                // set its width/height to the required ones
                buffer.width = width;
                buffer.height = height;
                // draw the main canvas on our buffer one
                // drawImage(source, source_X, source_Y, source_Width, source_Height, 
                //  dest_X, dest_Y, dest_Width, dest_Height)
                console.log((offsetX + width) + " " + (offsetY + height));
                b_ctx.drawImage(canvas, offsetX, offsetY, width, height,
                          0, 0, buffer.width, buffer.height);
                // now call the callback with the dataURL of our buffer canvas
                callback(buffer.toDataURL());
            };
            
            //draws rectangle   
            canvasHolder.onclick = function (e) {
                if (element !== null) {
                    element = null;
                    canvasHolder.style.cursor = "default";
                    
                    //TODO only works if you drag from top left to bottom right
                    //because of the offset (mouse.startX-20) and (mouse.startY-20)
                    var x = mouse.x; var y = mouse.y; var sX = mouse.startX; var sY = mouse.startY;
                    var posX = mouse.startX; var poxY = mouse.startY;
                    if (x >= sX && sY <= y) {
                        posX = sX; posY = sY;
                    } else if (x >= sX && sY >= y) {
                        posX = sX; posY = y;
                    } else if (x <= sX && sY <= y) {
                        posY = sY; posX = x;
                    } else if (x <= sX && sY >= y) {
                        posY = y; posX = x;
                    }
                    
                    //scanning the cropped img
                    crop(canvas, posX-15, posY-15, Math.abs(mouse.startX-mouse.x), Math.abs(mouse.startY-mouse.y), function(dataURL) {
                        //var img1 = new Image("url(" + dataURL + ")");
                        Tesseract.recognize(dataURL)
                        .progress(function  (p) { 
                            //console.log('progress', p)    
                        })
                        .then(function (result) { 
                            var arr = [];
                            result.words.forEach(function (w) {
                                arr.push(w.text);
                            });
                            console.log(arr);
                            //console.log(dataURL);
                            console.log(result);
                        })
                    });

                  //  console.log("finsihed.");
                } else {
                    //console.log("begun.");
                    var paras = document.getElementsByClassName('rectangle');

                    while(paras[0]) {
                        paras[0].parentNode.removeChild(paras[0]);
                    }
                    mouse.startX = mouse.x;
                    mouse.startY = mouse.y;
                    element = document.createElement('div');
                    element.className = 'rectangle'
                    element.style.left = mouse.x + 'px';
                    element.style.top = mouse.y + 'px';
                    canvasHolder.appendChild(element);
                    canvasHolder.style.cursor = "crosshair";
                    
                }
            }
        }
        
        </script>
    </head>
<body onload="init()">
    <div id="canvasHolder">
        <canvas id="myCanvas"  ></canvas></div>
        <button onclick="clearLines()">Clear me</button>
        <img src="dataTable.jpg" id="picture">
    
    <!--<button onclick="init()" width="100px" height="100px"></button>
    <input type="file" accept=".jpg, .png, .jpeg, .gif, .bmp, .tif, .tiff|images/*">
    <img src="numbersTestText.png" id="myimg">-->
    </body>
    
    
</html>