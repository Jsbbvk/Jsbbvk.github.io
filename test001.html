<!DOCTYPE html> <html>
<head>
<title>Pyro's Adventure</title>

<style>
pre {
    background-color: #F5F5F5;
	border: 1px solid black;
    display: inline-block;
	height: 400px;
    width: 100%;
    overflow: auto;
    background-color: #eeeeee;
	text-align: left;
	padding-left: 3px;
	font-size: 125%;
}
</style>
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script language="JavaScript">
	var pause = false;
	var shootable = !pause;
	var up = 1;
	var down = 2;
	var left = 3;
	var right = 4;
	
	var playerID = 0;
	var enemyID = 1;
	
	var mainImg = new Image();

	var attackImg ="http://www.clker.com/cliparts/y/m/X/o/s/R/down-arrow-circle-hi.png";
	var neutralImg = "http://www.iconsdb.com/icons/preview/royal-blue/circle-xxl.png";
	var neutral = 0;
	var attack = 1;
	var mainState = neutral; 
	mainImg.src=neutralImg;

	var mainImgRad = 25;
	mainImg.width = mainImgRad * 2;
	mainImg.height = mainImgRad * 2;
	var mainChar = {x: 250, y: 8*50};
	var dx = 50;
	var dy = 50;

	var enemyArr = [];
	var enemySRC = "http://www.iconsdb.com/icons/preview/purple/circle-xxl.png";

	var crosshair = new Image();
	crosshair.src="http://www.clipartbest.com/cliparts/dT8/xBB/dT8xBBGTe.png";
	crosshair.width = 20;
	crosshair.height = 20;
	var shootTimer = 0;
	
	
	var boundary  = new Image();
	boundary.src = "http://www.debscrossstitch.co.uk/ekmps/shops/debscrossstitch/images/bright-green-square-aperture-card-envelope-6-x-8-a5--3440-p.jpg";
	
	var terrainImg = [
		"url(https://www.hiveworkshop.com/attachments/map2-jpg.1494/)",
		"url(https://media.indiumgames.com/medialibrary/2014/07/MakingMap1.png)"
	];
	var terrainBound = [
		/*
		[
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
		],*/
		[
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
			[1, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1],
			[1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
			[1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1],
			[1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1],
			[1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1],
			[1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
			[1, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1],
			[1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
		]
	];
	var room = 0;
	
	
	
	var mouse  = {
		x:0,
		y:0
	};
	
	var bulletImg = new Image();
	bulletImg.src = "http://4.bp.blogspot.com/_UQmvUodh4h4/Saf1kylPhnI/AAAAAAAAC0w/rlTxf-P3eDQ/s400/Green+Square+copy.jpg"
	var bulletArr = [];
	
	class Bullet {
		constructor(x, y, endX, endY, shotFrom) {
			this.x = x;
			this.y = y;
			this.endX = endX;
			this.endY = endY;
			this.velocityX = 0;
			this.velocityY = 0;
			this.width = 10;
			this.height = 10;
			this.speed = 10;
			this.shotFrom = shotFrom;
		}
	}
	var bulShot = 0;
	var bulDeleted = 0;

	function start() {
		onTick();
		perSec();
		window.addEventListener("keydown", keyDown);
		document.getElementById("myCanvas").addEventListener("mousemove", mouseMove);
		document.getElementById("myCanvas").addEventListener("mousedown", mouseDown);
		chapterOne();
		
		/*
		for (var i = 0; i < terrainBound.length; i++) {
			for (var j = 0; j < terrainBound[i].length; j++) {
				for (var k = 0; k < terrainBound[i][j].length; k++) {
					if (terrainBound[i][j][k] == 1) {
						print(-mainImgRad + mainImgRad*2*k + " ");
					} else {
						print(0 + " ");
					}
				}
				println("");
			}
		}*/
		/*
		printlnTimer("He Was...", 0, 230, function() {
			printTimer("A kind Man With Nothing But ", 0, 150, function() {
				printTimer("A Compassionate Heart", 0, 100);
			});
		});
		for (var i = 0; i < 10; i++) {
			setTimeout(println("HI"), 500);
		}*/
		//print("HI");
		//for (var i = 0; i < 100; i++) {
		//	doScaledTimeout(i, 500);
		//}
		
		//spawnEnemy();
		/*
		println("HI");
		println("HI2");
		println("HIHIHAIHEFSIFHAS");
		println("ASFASDFASDFASDF");
		println("A");*/
	}
	
	
	function chapterOne() {
	
		pause = true;
		shootable = !pause;
		printlnTimer("Welcome Pyro!     ",0, 100, function() {
			printlnTimer("We've been expecting you for a long time.      ", 0, 100, function() {
				printTimer("Let me introduce myself,", 0, 100, function() {
					printlnTimer(" I am Oz the GREAT.", 0, 250);
				});
			});
		});
	
		//spawnEnemy();
		//spawnEnemy();
	
	
	
	
	
	}

	class Enemy {
		constructor(enemyRad, enemySRC, x, y) {
			this.enemyRad = enemyRad;
			this.enemySRC = enemySRC;
			this.enemyImg = new Image();
			this.enemyImg.src = this.enemySRC;
			this.x = x + this.enemyRad;
			this.y = y - this.enemyRad;	
		}
	}
	
	
	function mouseDown(e) {
		if (shootable) {
			if (shootTimer >= 25) {
				if (mainState == attack) {
					bulShot++;
					var dx = ((e.x) - mainChar.x);
					var dy = ((e.y) - mainChar.y);
					var mag = (Math.sqrt(dx * dx + dy * dy));

					var bullet = new Bullet(mainChar.x - 5, mainChar.y - 5, e.x, e.y, playerID);
					var lastBul = bulletArr.push(bullet) - 1;
					bulletArr[lastBul].velocityX = Math.floor((dx / mag) * bullet.speed);
					bulletArr[lastBul].velocityY = Math.floor(dy / mag * bullet.speed);
					shootTimer = 0;
				}
			}
		}
	}
	
	function enemyShoot() {
		if (enemyArr.length > 0) {
			var num = randomNum(0, enemyArr.length-1);
			var enemy = enemyArr[num];
			//println(num);
			var dx = (mainChar.x - enemy.x);
			var dy = (mainChar.y - enemy.y);
			var mag = (Math.sqrt(dx * dx + dy * dy));

			var bullet = new Bullet(enemy.x + enemy.enemyRad, enemy.y + enemy.enemyRad, mainChar.x + mainImgRad, mainChar.y + mainImgRad, enemyID);
			var lastBul = bulletArr.push(bullet) - 1;
			bulletArr[lastBul].velocityX = Math.floor(dx / mag * bullet.speed);
			bulletArr[lastBul].velocityY = Math.floor(dy / mag * bullet.speed);
		}
	}

	function doScaledTimeout(i, interval) {
	  setTimeout(function() {
		println(i);
	  }, i * interval);
	}
	
	function mouseMove(e) {
		mouse.x = e.x;
		mouse.y = e.y;
	}
		
	function keyDown(e) {
		/*
		if (e.keyCode == 80) {
			//'P'
			console.log(pause);
			if (!pause) {
				pause = true;
				shootable = !pause;
			} else {
				pause = false;
				shootable = !pause;
			}
		}*/
		if (!pause) {
			var dir;
			if(e.keyCode == 87) {
				//'W'
				moveChar(up);
				dir = up;
			}
			if(e.keyCode == 83) {
				//'S'
				moveChar(down);
				dir = down;
			}	
			if(e.keyCode == 65) {
				//'A'
				moveChar(left);
				dir = left;
			}
			if(e.keyCode == 68) {
				//'D'
				moveChar(right);
				dir = right;
			}
			if(e.keyCode == 32) {
				//space
				if (mainState == neutral) {
					mainState = attack;
					mainImg.src=attackImg;
				} else if(mainState == attack) {
					mainState = neutral;
					mainImg.src=neutralImg;
				}
			}
			checkWalls(dir);
		}
	}
	
	function moveChar(dir) {
		if (dir == up) {
			mainChar.y -= dy;
		} 
		if (dir == down) {
			mainChar.y += dy;
		}
		if (dir == left) {
			mainChar.x -= dx;
		}
		if (dir == right) {
			mainChar.x += dx;
		}
	}
		
	function isCollide(x1, y1, width1, height1, x2, y2, width2, height2) {
		var dist = ((x1 - x2) * (x1-x2) + (y1-y2) * (y1-y2));
		//console.log("Dist: " + width2);
		if (dist <= width2*width2) return true;
		return false;
	}
	
	function RectCircleColliding(cx, cy, cr, rx, ry, rh, rw){
		var distX = Math.abs(cx - rx - rw/2);
		var distY = Math.abs(cy - ry - rh/2);

		if (distX > (rw/2 + cr)) { return false; }
		if (distY > (rh/2 + cr)) { return false; }

		if (distX <= (rw/2)) { return true; } 
		if (distY <= (rh/2)) { return true; }

		var dx=distX-rw/2;
		var dy=distY-rh/2;
		return (dx*dx+dy*dy<=(cr*cr));
	}

	function checkWalls(dir) {
	/*
		if (mainChar.x <= mainImgRad) {
			mainChar.x = mainImgRad * 2;
		} else if (mainChar.x >= 450) {
			mainChar.x = 500 - mainImgRad * 2;
		}
		
		if (mainChar.y <= mainImgRad) {
			mainChar.y = mainImgRad * 2;
		} else if (mainChar.y >= 450) {
			mainChar.y = 500- mainImgRad * 2;
		}
	*/
		
		var x = Math.floor((mainChar.x) / (mainImgRad*2));
		var y = Math.floor((mainChar.y) / (mainImgRad*2));
		println(x + " + " + y);
		if (terrainBound[room][y][x] == 1) {
			if (dir == up) {
				mainChar.y += mainImgRad*2;
			} else if (dir == down) {
				mainChar.y -= mainImgRad*2;
			} else if (dir == left) {
				mainChar.x += mainImgRad*2;
			} else if (dir == right) {
				mainChar.x -= mainImgRad*2;
			}
		}
		println(terrainBound[room][y][x]);
	}

	function onTick() {
		window.setTimeout(onTick, 20);
		if (shootable) {
			shootTimer++;
		}
		drawScreen();
	}
	
	function perSec() {
		window.setTimeout(perSec, 1000);
		
		if (randomBool(40)) {
			enemyShoot();
		}
	}

	function randomNum(min, max) {
	   var range = (max - min) + 1;     
	   return Math.floor((Math.random() * range) + min);
	}
	
	function randomBool(per) {
		//assuming that per is 0 - 100
		per /= 100;
		//println(per);
		return Math.random() <= per;
	}


	function spawnEnemy() {
		var xCoor = randomNum(0, Math.round(document.getElementById("myCanvas").width / dx) - 3);
		//println(xCoor);
		var enemy1 = new Enemy(mainImgRad, enemySRC, xCoor * dx, dy);
		//println(enemy1.x);
		//println(xCoor * dx);
		//println(enemy1.y);
		
		enemyArr.push(enemy1);
	}
		
	function drawScreen() {
	
		var canvas = document.getElementById("myCanvas");
		var context = canvas.getContext("2d");
		var height = canvas.height;
		var width = canvas.width;
		var div = document.getElementById("myDiv");
		
	
		context.clearRect(0, 0, 500, 500);
		div.style.backgroundImage = terrainImg[room];
		div.style.backgroundRepeat = "no-repeat";
		div.style.backgroundSize = "500px 500px";
		
		context.setLineDash([1, 1]);/*dashes are 1px and spaces are 1px*/
		for (var i = 0; i < height / (dy); i++) {
			context.beginPath();
			context.moveTo(0, i * (dy));
			context.lineTo(width, i * (dy));
			context.stroke();
		}
		
		for (var i = 0; i < width / (dx); i++) {
			context.beginPath();
			context.moveTo(i * (dx), 0);
			context.lineTo(i * (dx), height);
			context.stroke();
		}
		//boundary
		
		for (var q = 0; q < terrainBound[room].length; q++) {
			for (var k = 0; k < terrainBound[room][q].length; k++) {
				if (terrainBound[room][q][k] == 1) {
					context.drawImage(boundary, -mainImgRad + mainImgRad*2*k, -mainImgRad + mainImgRad*2*q, mainImgRad*2, mainImgRad*2);
				}
			}
		}
		
		//enemy
		for (var i = 0; i < enemyArr.length; i++) {
			var enemy = enemyArr[i];
			context.drawImage(enemy.enemyImg, enemy.x, enemy.y, enemy.enemyRad * 2, enemy.enemyRad * 2);
		}
		//bullet
		for (var i = 0; i < bulletArr.length; i++) {
			var bullet = bulletArr[i];
			context.drawImage(bulletImg, bullet.x, bullet.y - bullet.height, bullet.width, bullet.height);
			bullet.x += bullet.velocityX;
			bullet.y += bullet.velocityY;
			//boundary
			if (bullet.x >= canvas.width || bullet.x <= 0 || bullet.y >= canvas.height || bullet.y <= 0) {
				bulletArr.splice(i, 1);
				bulDeleted++;
				//console.log("deleted: " + bulDeleted + " shot: " + bulShot);
			}
			
			if (bullet.shotFrom == playerID) {
				for (var j = 0; j < enemyArr.length; j++) {
					var enemy = enemyArr[j];
					//console.log("bulX: " + bullet.x + "  bulY: " + bullet.y);
					//console.log("enemyX: " + enemy.x + " enemyY: " + enemy.y);
					//if (isCollide(Math.ceil(bullet.x), Math.ceil(bullet.y), bullet.width, bullet.height, enemy.x, enemy.y, enemy.enemyRad * 2, enemy.enemyRad * 2)) {
					if (RectCircleColliding(enemy.x, enemy.y, enemy.enemyRad, Math.ceil(bullet.x), Math.ceil(bullet.y), bullet.width, bullet.height)) {
						//delete enemy
						enemyArr.splice(j, 1);
						bulletArr.splice(i, 1);
						bulDeleted++;
						//console.log("HIT");
						i--;
					}
				}
			} else if (bullet.shotFrom == enemyID) {
				//if (isCollide(Math.ceil(bullet.x), Math.ceil(bullet.y), bullet.width, bullet.height, mainChar.x + mainImgRad, mainChar.y + mainImgRad, mainImgRad * 2, mainImgRad * 2)) {
				if (RectCircleColliding(mainChar.x, mainChar.y, mainImgRad, Math.ceil(bullet.x), Math.ceil(bullet.y), bullet.width, bullet.height)) {
					println("SHOT!");
					bulletArr.splice(i, 1);
					i--;
					//shot player
				}
				
			}
			
		}
		//crosshair
		if(mainState == attack) {
			context.drawImage(crosshair, mouse.x - crosshair.width , mouse.y - crosshair.height , crosshair.width, crosshair.height);
		}
		
		//player
		var center_x = mainChar.x + mainImg.width / 2;
	    var center_y = mainChar.y + mainImg.height / 2;
	    var angle = -Math.atan2(mouse.x - center_x, mouse.y - center_y);
		
	    rotateImg(context, mainImg, angle, mainChar.x, mainChar.y, mainImg.width / 2, mainImg.height / 2);
		
	}
	function rotateImg(context, image, angleInRad, positionX, positionY, axisX, axisY) {
	  context.translate(positionX, positionY);
	  context.rotate(angleInRad);
	  context.drawImage(image, -axisX, -axisY, mainImgRad * 2, mainImgRad * 2);
	  context.rotate(-angleInRad);
	  context.translate(-positionX, -positionY);
	}

		
	function println(words) {
		var console = document.getElementById("console");
		var linebr = document.createElement("br");
		console.append(words);
		console.append(linebr);
		console.scrollTop += 50;
	}

	function printlnTimer(message, index, interval, callback) {
	  var console = document.getElementById("console");
	  if (index < message.length) { 
		console.append(message[index++]); 
		setTimeout(function () { printlnTimer(message, index, interval, callback); }, interval); 
	  } else {
		var linebr = document.createElement("br");
		console.append(linebr);
		callback && callback();
	  }
	  console.scrollTop += 50;
	};

	function print(words) {
		var console = document.getElementById("console");
		console.append(words);
		console.scrollTop += 50;
	}

	function printTimer(message, index, interval, callback) {
	  var console = document.getElementById("console");
	  if (index < message.length) { 
		console.append(message[index++]); 
		setTimeout(function () { printTimer(message, index, interval, callback); }, interval); 
	  } else {
		callback && callback();
	  }
	  console.scrollTop += 50;
	};


</script>
</head><body onload="start()">


<table>
<tr height="100%">
<td width="50%">
<div id="myDiv">
<canvas id="myCanvas" width="500" height="500">
Your browser does not support the HTML5 canvas tag.
</canvas></div></td>


<td width="50%">
<div id="div2" style="text-align:center" >
<pre id="console"></pre></div>
</td>
</tr>
</table>
</body>
</html>